var b=($,B,c)=>new Promise((h,x)=>{var w=d=>{try{p(c.next(d))}catch(o){x(o)}},n=d=>{try{p(c.throw(d))}catch(o){x(o)}},p=d=>d.done?h(d.value):Promise.resolve(d.value).then(w,n);p((c=c.apply($,B)).next())});import{v as de,r as k,h as j,i as ue,c as U,o as f,J as a,S as l,b as u,G as r,M as q,N as E,T as i,I as pe,aa as ce,V,R as g,p as F,H as P,ay as C,k as me,aA as I,_ as _e}from"./index-B-MJRUf7.js";import{g as fe,c as ge,a as ye,d as ve}from"./tasks-DBoxgTp_.js";import{g as be}from"./websites-diupm8oD.js";import{f as L}from"./time-Rad8uJFk.js";const ke={class:"task-manage"},xe={class:"flex flex-wrap items-center gap-4"},we={class:"flex items-center gap-2"},Ve={class:"flex items-center gap-2"},Ce={class:"flex items-center gap-2"},he={class:"text-sm"},Te={class:"mt-4 flex justify-end"},Be=de({name:"TaskManage",__name:"index",setup($){const B=me(),c=k(!1),h=k([]),x=k(0),w=k([]),n=j({website_id:"",status:"",page:1,page_size:20}),p=k(!1),d=k(),o=j({website_id:"",strategy:"incremental",depth:3,max_links:1e3}),W={website_id:[{required:!0,message:"请选择网站",trigger:"change"}],strategy:[{required:!0,message:"请选择策略",trigger:"change"}]},A=s=>({pending:"info",running:"warning",completed:"success",failed:"danger",cancelled:""})[s]||"info",G=s=>({pending:"等待中",running:"运行中",completed:"已完成",failed:"失败",cancelled:"已取消"})[s]||s,H=s=>s==="incremental"?"增量":"全量",J=()=>b(null,null,function*(){try{const s=yield be({status:"active"});s.success&&(w.value=s.data)}catch(s){console.error("加载网站列表失败",s)}}),y=()=>b(null,null,function*(){c.value=!0;try{const s=yield fe(n);s.success&&(h.value=s.data,x.value=s.pagination.total)}catch(s){C.error("加载任务列表失败")}finally{c.value=!1}}),O=()=>{Object.assign(o,{website_id:"",strategy:"incremental",depth:3,max_links:1e3}),p.value=!0},Q=()=>b(null,null,function*(){d.value&&(yield d.value.validate(s=>b(null,null,function*(){if(s)try{yield ge(o),C.success("爬取任务已创建"),p.value=!1,y()}catch(e){C.error(e.message||"创建任务失败")}})))}),K=s=>{B.push(`/crawler/tasks/${s.id}`)},X=s=>`${(s*100).toFixed(2)}%`,Y=s=>{n.page=s,y()},Z=()=>{n.page=1,y()},ee=()=>{n.website_id="",n.status="",n.page=1,y()},te=s=>{I.confirm(`确定要取消任务"${s.id}"吗？任务将在下一个检查点停止。`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>b(null,null,function*(){try{yield ye(s.id),C.success("任务取消请求已发送"),y()}catch(e){}})).catch(()=>{})},ae=s=>{I.confirm(`确定要删除任务"${s.id}"吗？此操作将同时删除任务的所有日志记录。`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>b(null,null,function*(){try{yield ve(s.id),C.success("任务已删除"),y()}catch(e){}})).catch(()=>{})};return ue(()=>{J(),y()}),(s,e)=>{const v=r("el-option"),z=r("el-select"),m=r("el-button"),D=r("el-card"),_=r("el-table-column"),S=r("el-tag"),le=r("el-table"),se=r("el-pagination"),T=r("el-form-item"),M=r("el-radio"),ne=r("el-radio-group"),N=r("el-input-number"),oe=r("el-form"),ie=r("el-dialog"),re=ce("loading");return f(),U("div",ke,[a(D,{class:"mb-4"},{default:l(()=>[u("div",xe,[u("div",we,[e[9]||(e[9]=u("span",{class:"text-sm whitespace-nowrap"},"网站",-1)),a(z,{modelValue:n.website_id,"onUpdate:modelValue":e[0]||(e[0]=t=>n.website_id=t),placeholder:"请选择网站",style:{width:"200px"},clearable:""},{default:l(()=>[(f(!0),U(q,null,E(w.value,t=>(f(),V(v,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),u("div",Ve,[e[10]||(e[10]=u("span",{class:"text-sm whitespace-nowrap"},"状态",-1)),a(z,{modelValue:n.status,"onUpdate:modelValue":e[1]||(e[1]=t=>n.status=t),placeholder:"请选择状态",style:{width:"150px"},clearable:""},{default:l(()=>[a(v,{label:"等待中",value:"pending"}),a(v,{label:"运行中",value:"running"}),a(v,{label:"已完成",value:"completed"}),a(v,{label:"失败",value:"failed"}),a(v,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),u("div",Ce,[a(m,{type:"primary",onClick:Z},{default:l(()=>e[11]||(e[11]=[i("查询",-1)])),_:1,__:[11]}),a(m,{onClick:ee},{default:l(()=>e[12]||(e[12]=[i("重置",-1)])),_:1,__:[12]}),a(m,{type:"success",onClick:O},{default:l(()=>e[13]||(e[13]=[i("创建任务",-1)])),_:1,__:[13]})])])]),_:1}),a(D,null,{default:l(()=>[pe((f(),V(le,{data:h.value,stripe:""},{default:l(()=>[a(_,{prop:"website.name",label:"网站",width:"150","show-overflow-tooltip":""}),a(_,{prop:"task_type",label:"类型",width:"80"},{default:l(({row:t})=>[i(g(t.task_type==="manual"?"手动":"定时"),1)]),_:1}),a(_,{prop:"strategy",label:"策略",width:"80"},{default:l(({row:t})=>[a(S,{type:t.strategy==="incremental"?"success":"warning",size:"small"},{default:l(()=>[i(g(H(t.strategy)),1)]),_:2},1032,["type"])]),_:1}),a(_,{prop:"status",label:"状态",width:"100"},{default:l(({row:t})=>[a(S,{type:A(t.status)},{default:l(()=>[i(g(G(t.status)),1)]),_:2},1032,["type"])]),_:1}),a(_,{label:"统计","min-width":"200"},{default:l(({row:t})=>[u("div",he,[u("div",null,"总链接: "+g(t.statistics.total_links),1),u("div",null,"新增: "+g(t.statistics.new_links),1),u("div",null,"有效率: "+g(X(t.statistics.valid_rate)),1)])]),_:1}),a(_,{prop:"started_at",label:"开始时间",width:"180"},{default:l(({row:t})=>[i(g(F(L)(t.started_at)),1)]),_:1}),a(_,{prop:"completed_at",label:"完成时间",width:"180"},{default:l(({row:t})=>[i(g(F(L)(t.completed_at)),1)]),_:1}),a(_,{label:"操作",width:"250",fixed:"right"},{default:l(({row:t})=>[a(m,{type:"primary",size:"small",onClick:R=>K(t)},{default:l(()=>e[14]||(e[14]=[i(" 查看详情 ",-1)])),_:2,__:[14]},1032,["onClick"]),t.status==="running"?(f(),V(m,{key:0,type:"warning",size:"small",onClick:R=>te(t)},{default:l(()=>e[15]||(e[15]=[i(" 取消 ",-1)])),_:2,__:[15]},1032,["onClick"])):P("",!0),t.status!=="running"?(f(),V(m,{key:1,type:"danger",size:"small",onClick:R=>ae(t)},{default:l(()=>e[16]||(e[16]=[i(" 删除 ",-1)])),_:2,__:[16]},1032,["onClick"])):P("",!0)]),_:1})]),_:1},8,["data"])),[[re,c.value]]),u("div",Te,[a(se,{"current-page":n.page,"onUpdate:currentPage":e[2]||(e[2]=t=>n.page=t),"page-size":n.page_size,total:x.value,layout:"total, prev, pager, next, jumper",onCurrentChange:Y},null,8,["current-page","page-size","total"])])]),_:1}),a(ie,{modelValue:p.value,"onUpdate:modelValue":e[8]||(e[8]=t=>p.value=t),title:"创建爬取任务",width:"600px","close-on-click-modal":!1},{footer:l(()=>[a(m,{onClick:e[7]||(e[7]=t=>p.value=!1)},{default:l(()=>e[19]||(e[19]=[i("取消",-1)])),_:1,__:[19]}),a(m,{type:"primary",onClick:Q},{default:l(()=>e[20]||(e[20]=[i("确定",-1)])),_:1,__:[20]})]),default:l(()=>[a(oe,{ref_key:"formRef",ref:d,model:o,rules:W,"label-width":"120px"},{default:l(()=>[a(T,{label:"选择网站",prop:"website_id"},{default:l(()=>[a(z,{modelValue:o.website_id,"onUpdate:modelValue":e[3]||(e[3]=t=>o.website_id=t),placeholder:"请选择网站",style:{width:"100%"}},{default:l(()=>[(f(!0),U(q,null,E(w.value,t=>(f(),V(v,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(T,{label:"爬取策略",prop:"strategy"},{default:l(()=>[a(ne,{modelValue:o.strategy,"onUpdate:modelValue":e[4]||(e[4]=t=>o.strategy=t)},{default:l(()=>[a(M,{label:"incremental"},{default:l(()=>e[17]||(e[17]=[i("增量爬取（仅爬取新链接）",-1)])),_:1,__:[17]}),a(M,{label:"full"},{default:l(()=>e[18]||(e[18]=[i("全量爬取（重新爬取所有链接）",-1)])),_:1,__:[18]})]),_:1},8,["modelValue"])]),_:1}),a(T,{label:"爬取深度"},{default:l(()=>[a(N,{modelValue:o.depth,"onUpdate:modelValue":e[5]||(e[5]=t=>o.depth=t),min:1,max:10,"controls-position":"right"},null,8,["modelValue"])]),_:1}),a(T,{label:"最大链接数"},{default:l(()=>[a(N,{modelValue:o.max_links,"onUpdate:modelValue":e[6]||(e[6]=t=>o.max_links=t),min:100,max:1e5,step:100,"controls-position":"right"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Me=_e(Be,[["__scopeId","data-v-090d6ccd"]]);export{Me as default};
